/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    BugBuster Nextflow config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Default config options for all compute environments
----------------------------------------------------------------------------------------
*/

// Pipeline manifest
manifest {
    name            = 'gene2dis/BugBuster'
    author          = """Francisco A. Fuentes, Juan A. Ugalde, Carolina Curiqueo"""
    homePage        = 'https://github.com/gene2dis/BugBuster'
    description     = """Bacterial Unraveling and metaGenomic Binning with Up-Scale Throughput, Efficient and Reproducible"""
    mainScript      = 'main.nf'
    nextflowVersion = '!>=23.04.0'
    version         = '1.0.0'
    doi             = ''
}

// Global default params
params {
    // Output options
    outdir                     = output ?: './results'
    publish_dir_mode           = 'copy'
    tracedir                   = "${params.outdir}/pipeline_info"
    
    // Max resource options (defaults - can be overridden)
    max_memory                 = '128.GB'
    max_cpus                   = 16
    max_time                   = '240.h'
    
    // Schema validation
    validationShowHiddenParams = false
    validationSchemaIgnoreParams = 'genomes,igenomes_base'
}

// Profiles for different execution environments
profiles {
    debug {
        dumpHashes              = true
        process.beforeScript    = 'echo $HOSTNAME'
        cleanup                 = false
        nextflow.enable.configProcessNamesValidation = true
    }
    conda {
        conda.enabled           = true
        docker.enabled          = false
        singularity.enabled     = false
        podman.enabled          = false
        shifter.enabled         = false
        charliecloud.enabled    = false
        apptainer.enabled       = false
    }
    docker {
        docker.enabled          = true
        conda.enabled           = false
        singularity.enabled     = false
        podman.enabled          = false
        shifter.enabled         = false
        charliecloud.enabled    = false
        apptainer.enabled       = false
        docker.runOptions       = '-u $(id -u):$(id -g)'
    }
    singularity {
        singularity.enabled     = true
        singularity.autoMounts  = true
        conda.enabled           = false
        docker.enabled          = false
        podman.enabled          = false
        shifter.enabled         = false
        charliecloud.enabled    = false
        apptainer.enabled       = false
    }
    podman {
        podman.enabled          = true
        conda.enabled           = false
        docker.enabled          = false
        singularity.enabled     = false
        shifter.enabled         = false
        charliecloud.enabled    = false
        apptainer.enabled       = false
    }
    apptainer {
        apptainer.enabled       = true
        apptainer.autoMounts    = true
        conda.enabled           = false
        docker.enabled          = false
        singularity.enabled     = false
        podman.enabled          = false
        shifter.enabled         = false
        charliecloud.enabled    = false
    }
    // Legacy profiles for backward compatibility
    local_docker {
        docker.enabled          = true
        singularity.enabled     = false
        docker.runOptions       = '-u $(id -u):$(id -g)'
    }
    slurm_singularity {
        process.executor        = 'slurm'
        singularity.enabled     = true
        singularity.autoMounts  = true
        docker.enabled          = false
    }
    // Test profile with minimal test data
    test {
        includeConfig 'conf/test.config'
    }

    //
    // Cloud execution profiles
    //
    aws {
        includeConfig 'conf/aws.config'
    }
    gcp {
        includeConfig 'conf/gcp.config'
    }
    azure {
        includeConfig 'conf/azure.config'
    }

    //
    // HPC profiles
    //
    slurm {
        includeConfig 'conf/slurm.config'
    }
}

// Pipeline execution parameters
params {
    // Input/Output options
    input                      = null
    output                     = null

    // Pipeline execution options
    quality_control            = true
    assembly_mode              = "assembly"    // Options: "coassembly", "assembly", "none"
    taxonomic_profiler         = "sourmash"    // Options: "kraken2", "sourmash", "none"
    
    // Feature toggles
    help                       = false
    read_arg_prediction        = false
    contig_level_metacerberus  = false
    contig_tax_and_arg         = false
    include_binning            = false
    arg_bin_clustering         = false

    // Quality filtering
    min_read_sample            = 0

    // Database selection (automatic download)
    phiX_index                 = 'phiX174'
    host_db                    = 'human'
    kraken2_db                 = 'standard-8'
    karga_db                   = 'megares'
    kargva_db                  = 'kargva'
    sourmash_db                = 'gtdb_220_k31'
    blast_db                   = 'nt'
    taxdump_files              = 'ncbi'
    checkm2_db                 = 'v3'
    gtdbtk_db                  = 'release_220'

    // Custom database paths (overrides automatic download)
    custom_phiX_index          = null
    custom_bowtie_host_index   = null
    custom_kraken_db           = null
    custom_karga_db            = null
    custom_kargva_db           = null
    custom_sourmash_db         = null  // Needs to be a list: ["kmer_file","lineages_file"]
    custom_blast_db            = null
    custom_taxdump_files       = null
    custom_deeparg_db          = null
    custom_checkm2_db          = null
    custom_gtdbtk_db           = null

    // Tool-specific parameters
    // FASTP
    fastp_n_base_limit               = 5
    fastp_unqualified_percent_limit  = 10
    fastp_qualified_quality_phred    = 20
    fastp_cut_front_window_size      = 4
    fastp_cut_front_mean_quality     = 20
    fastp_cut_right_window_size      = 4
    fastp_cut_right_mean_quality     = 20

    // KRAKEN2
    kraken_confidence          = 0.1
    kraken_db_used             = "gtdb_release207"

    // BRACKEN
    bracken_read_len           = 150
    bracken_tax_level          = "S"

    // SOURMASH (tax_rank options: "genus", "species", "strain")
    sourmash_db_name           = "gtdb_release_220"
    sourmash_tax_rank          = "species"

    // BOWTIE2
    bowtie_ma                  = 2
    bowtie_mp                  = '6,2'
    bowtie_score_min           = 'G,15,6'
    bowtie_k                   = 1
    bowtie_N                   = 1
    bowtie_L                   = 20
    bowtie_R                   = 2
    bowtie_i                   = 'S,1,0.75'

    // BBMAP
    bbmap_lenght               = 1000

    // METABAT2
    metabat_minContig          = 2500
    metabat_maxP               = 95
    metabat_minS               = 60
    metabat_maxEdges           = 200
    metabat_pTNF               = 0
    metabat_minCV              = 1
    metabat_minCVSum           = 1
    metabat_minClsSize         = 200000

    // METAWRAP
    metawrap_completeness      = 50
    metawrap_contamination     = 10

    // MMSEQS2
    mmseqs_start_sens          = 2
    mmseqs_s                   = 7
    mmseqs_sens_steps          = 3
    mmseqs_min_seq_id          = 0.8
    mmseqs_c                   = 0.7
    mmseqs_cov_mode            = 2
    mmseqs_e                   = 1e-20
    mmseqs_format_mode         = 4
    mmseqs_alignment_mode      = 3
    mmseqs_max_seqs            = 10000
    mmseqs_format_output       = "empty,query,target,evalue,pident,qcov,tcov,tseq"

    // DEEPARG
    deeparg_min_prob                     = 0.8
    deeparg_arg_alignment_identity       = 50
    deeparg_arg_alignment_evalue         = "1e-10"
    deeparg_arg_alignment_overlap        = 0.8
    deeparg_arg_num_alignments_per_entry = 1000
    deeparg_model_version                = 'v2'

    // METACERBERUS (HMM options: KOFam_all, KOFam_eukaryote, KOFam_prokaryote, COG, VOG, PHROG, CAZy)
    metacerberus_hmm           = '"KOFam_all, COG, VOG, PHROG, CAZy"'
    metacerberus_minscore      = 25
    metacerberus_evalue        = 1e-09

    // SEMIBIN (models: human_gut, dog_gut, ocean, soil, cat_gut, human_oral, mouse_gut, pig_gut, built_environment, wastewater, chicken_caecum, global)
    semibin_env_model          = "human_gut"
}

/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Process resource definitions
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

// Function to check max resources
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max memory '${params.max_memory}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max time '${params.max_time}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.max_cpus as int )
        } catch (all) {
            println "   ### ERROR ###   Max cpus '${params.max_cpus}' is not valid! Using default value: $obj"
            return obj
        }
    }
}

process {
    // Default error strategy
    errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'finish' }
    maxRetries    = 2
    maxErrors     = '-1'

    // Process resource labels with memory and time
    withLabel:process_download {
        cpus   = { check_max( 1, 'cpus' ) }
        memory = { check_max( 2.GB, 'memory' ) }
        time   = { check_max( 4.h * task.attempt, 'time' ) }
        errorStrategy = 'retry'
        maxRetries = 3
    }

    withLabel:process_single {
        cpus   = { check_max( 1, 'cpus' ) }
        memory = { check_max( 4.GB * task.attempt, 'memory' ) }
        time   = { check_max( 4.h * task.attempt, 'time' ) }
    }

    withLabel:process_low {
        cpus   = { check_max( 4, 'cpus' ) }
        memory = { check_max( 12.GB * task.attempt, 'memory' ) }
        time   = { check_max( 8.h * task.attempt, 'time' ) }
    }

    withLabel:process_medium {
        cpus   = { check_max( 8, 'cpus' ) }
        memory = { check_max( 36.GB * task.attempt, 'memory' ) }
        time   = { check_max( 24.h * task.attempt, 'time' ) }
    }

    withLabel:process_high {
        cpus   = { check_max( 16, 'cpus' ) }
        memory = { check_max( 72.GB * task.attempt, 'memory' ) }
        time   = { check_max( 72.h * task.attempt, 'time' ) }
    }

    withLabel:process_long {
        time   = { check_max( 120.h * task.attempt, 'time' ) }
    }

    withLabel:process_high_memory {
        memory = { check_max( 128.GB * task.attempt, 'memory' ) }
    }

    withLabel:error_ignore {
        errorStrategy = 'ignore'
    }

    withLabel:error_retry {
        errorStrategy = 'retry'
        maxRetries    = 3
    }
}

/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Execution reports and tracing
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

def trace_timestamp = new java.util.Date().format('yyyy-MM-dd_HH-mm-ss')

timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_timeline_${trace_timestamp}.html"
}
report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_report_${trace_timestamp}.html"
}
trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_trace_${trace_timestamp}.txt"
}
dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/pipeline_dag_${trace_timestamp}.svg"
}

/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Load config files
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

includeConfig 'config/databases.config'
includeConfig 'config/modules.config'

// Load base.config by default for all pipelines
try {
    includeConfig 'conf/base.config'
} catch (Exception e) {
    // conf/base.config is optional
}
