/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    SLURM HPC Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Configuration for running BugBuster on SLURM-managed HPC clusters

    Use as follows:
        nextflow run main.nf -profile slurm,singularity --outdir /path/to/results

----------------------------------------------------------------------------------------
*/

params {
    config_profile_name        = 'SLURM HPC'
    config_profile_description = 'SLURM cluster execution with Singularity containers'
}

process {
    executor = 'slurm'
    
    // Default queue/partition
    queue = params.slurm_queue ?: 'normal'
    
    // Account for job submission (if required)
    clusterOptions = params.slurm_account ? "--account=${params.slurm_account}" : ''
    
    // Time limits based on process labels
    withLabel: 'process_single' {
        queue = params.slurm_queue_short ?: params.slurm_queue ?: 'normal'
        time  = '4.h'
    }
    withLabel: 'process_low' {
        queue = params.slurm_queue_short ?: params.slurm_queue ?: 'normal'
        time  = '8.h'
    }
    withLabel: 'process_medium' {
        queue = params.slurm_queue ?: 'normal'
        time  = '24.h'
    }
    withLabel: 'process_high' {
        queue = params.slurm_queue_long ?: params.slurm_queue ?: 'normal'
        time  = '72.h'
    }
    withLabel: 'process_long' {
        queue = params.slurm_queue_long ?: params.slurm_queue ?: 'normal'
        time  = '168.h'
    }
    
    // Error handling
    errorStrategy = { task.exitStatus in [143,137,104,134,139,140] ? 'retry' : 'finish' }
    maxRetries    = 2
}

executor {
    name            = 'slurm'
    queueSize       = params.slurm_queue_size ?: 100
    submitRateLimit = '10 sec'
    pollInterval    = '30 sec'
    
    // Exit status for completed jobs
    exitReadTimeout = '10 min'
}

// Singularity settings for HPC
singularity {
    enabled    = true
    autoMounts = true
    
    // Cache directory for container images
    cacheDir   = params.singularity_cache ?: "${System.getenv('HOME') ?: '/tmp'}/.singularity/cache"
    
    // Pull timeout for large images
    pullTimeout = '60 min'
    
    // Run options
    runOptions = params.singularity_run_options ?: ''
}

// Environment modules (if needed)
// env {
//     PATH = "/path/to/tools:\$PATH"
// }
