/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    AWS Batch Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Configuration for running BugBuster on AWS Batch with S3 storage

    Use as follows:
        nextflow run main.nf -profile aws,docker --outdir s3://bucket/results

    Required environment variables or Nextflow secrets:
        - AWS_ACCESS_KEY_ID
        - AWS_SECRET_ACCESS_KEY
        - AWS_DEFAULT_REGION

----------------------------------------------------------------------------------------
*/

params {
    config_profile_name        = 'AWS Batch'
    config_profile_description = 'AWS Batch execution with S3 storage'
}

process {
    executor = 'awsbatch'
    queue    = { params.aws_queue ?: 'default' }
    
    // Use Fusion filesystem for improved S3 performance (Nextflow 23.10+)
    // scratch = false
    
    // Error handling for spot instances
    errorStrategy = { task.exitStatus in [143,137,104,134,139,140] ? 'retry' : 'finish' }
    maxRetries    = 3
}

aws {
    region = params.aws_region ?: 'us-east-1'
    
    batch {
        cliPath       = '/home/ec2-user/miniconda/bin/aws'
        maxParallelTransfers = 4
        maxTransferAttempts  = 3
        delayBetweenAttempts = '5 sec'
        
        // Job definition settings
        jobRole       = params.aws_job_role ?: null
        executionRole = params.aws_execution_role ?: null
        
        // Volumes for scratch space
        volumes = params.aws_volumes ?: null
    }
    
    client {
        maxConnections         = 20
        connectionTimeout      = 10000
        socketTimeout          = 0
        maxErrorRetry          = 5
        uploadMaxThreads       = 4
        uploadChunkSize        = '100MB'
        uploadMaxAttempts      = 5
        uploadRetrySleep       = '10 sec'
    }
}

// Fusion filesystem for better S3 performance (optional, requires Nextflow 23.10+)
// fusion {
//     enabled = true
//     exportStorageCredentials = true
// }

// Wave container provisioning (optional, for on-the-fly container builds)
// wave {
//     enabled = true
// }

// S3 work directory
workDir = params.aws_workdir ?: 's3://your-bucket/work'

// Container settings for AWS
docker {
    enabled   = true
    runOptions = '-u $(id -u):$(id -g)'
}

// Tower/Seqera Platform integration (optional)
// tower {
//     enabled    = true
//     accessToken = secrets.TOWER_ACCESS_TOKEN
//     workspaceId = params.tower_workspace_id
// }
