/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Azure Batch Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Configuration for running BugBuster on Azure Batch with Azure Blob storage

    Use as follows:
        nextflow run main.nf -profile azure,docker --outdir az://container/results

    Required environment variables:
        - AZURE_BATCH_ACCOUNT_NAME
        - AZURE_BATCH_ACCOUNT_KEY
        - AZURE_STORAGE_ACCOUNT_NAME
        - AZURE_STORAGE_ACCOUNT_KEY

----------------------------------------------------------------------------------------
*/

params {
    config_profile_name        = 'Azure Batch'
    config_profile_description = 'Azure Batch execution with Azure Blob storage'
}

process {
    executor = 'azurebatch'
    queue    = { params.azure_pool ?: 'auto' }
    
    // Error handling for spot instances
    errorStrategy = { task.exitStatus in [143,137,104,134,139,140,50001] ? 'retry' : 'finish' }
    maxRetries    = 3
}

azure {
    batch {
        location         = params.azure_region ?: 'eastus'
        accountName      = params.azure_batch_account ?: null
        accountKey       = params.azure_batch_key ?: null
        
        // Auto pool settings (creates pools on demand)
        autoPoolMode     = true
        allowPoolCreation = true
        deletePoolsOnCompletion = params.azure_delete_pools ?: true
        
        // Pool configuration
        pools {
            auto {
                vmType     = params.azure_vm_type ?: 'Standard_D4_v3'
                vmCount    = params.azure_vm_count ?: 1
                maxVmCount = params.azure_max_vms ?: 10
                
                // Use spot instances for cost savings
                lowPriority = params.azure_spot ?: false
                
                // Scale settings
                scaleFormula = '''
                    $samples = $PendingTasks.GetSamplePercent(TimeInterval_Minute * 5);
                    $tasks = $samples < 70 ? max(0, $PendingTasks.GetSample(1)) : max($PendingTasks.GetSample(1), avg($PendingTasks.GetSample(TimeInterval_Minute * 5)));
                    $targetVMs = $tasks > 0 ? $tasks : max(0, $TargetDedicatedNodes/2);
                    $TargetLowPriorityNodes = max(0, min($targetVMs, ''' + (params.azure_max_vms ?: 10) + '''));
                    $TargetDedicatedNodes = 0;
                    $NodeDeallocationOption = taskcompletion;
                '''
            }
        }
    }
    
    storage {
        accountName = params.azure_storage_account ?: null
        accountKey  = params.azure_storage_key ?: null
    }
    
    // Azure Active Directory authentication (alternative to keys)
    activeDirectory {
        // servicePrincipalId = params.azure_sp_id
        // servicePrincipalSecret = params.azure_sp_secret
        // tenantId = params.azure_tenant_id
    }
}

// Fusion filesystem for better Azure Blob performance (optional)
// fusion {
//     enabled = true
//     exportStorageCredentials = true
// }

// Wave container provisioning (optional)
// wave {
//     enabled = true
// }

// Azure Blob work directory
workDir = params.azure_workdir ?: 'az://container/work'

// Container settings
docker {
    enabled = true
}

// Tower/Seqera Platform integration (optional)
// tower {
//     enabled    = true
//     accessToken = secrets.TOWER_ACCESS_TOKEN
//     workspaceId = params.tower_workspace_id
// }
