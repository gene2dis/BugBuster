/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Institutional Configuration Template
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Template for creating institution-specific configurations.
    Copy this file and customize for your HPC/cloud environment.

    Usage:
        1. Copy to conf/my_institution.config
        2. Customize settings below
        3. Add profile to nextflow.config profiles block
        4. Run: nextflow run main.nf -profile my_institution

----------------------------------------------------------------------------------------
*/

params {
    // Profile identification
    config_profile_name        = 'My Institution'
    config_profile_description = 'Configuration for My Institution HPC cluster'
    config_profile_contact     = 'admin@institution.edu'
    config_profile_url         = 'https://hpc.institution.edu'

    // -------------------------------------------------------------------------
    // CLUSTER SETTINGS - Customize these for your environment
    // -------------------------------------------------------------------------
    
    // SLURM partition/queue names (adjust to match your cluster)
    slurm_queue       = 'general'      // Default partition
    slurm_queue_short = 'short'        // For quick jobs (<8h)
    slurm_queue_long  = 'long'         // For extended jobs (>24h)
    slurm_account     = null           // Account/allocation name if required
    
    // -------------------------------------------------------------------------
    // CONTAINER SETTINGS
    // -------------------------------------------------------------------------
    
    // Singularity cache location (use shared filesystem for efficiency)
    singularity_cache = '/shared/containers/singularity'
    
    // Additional Singularity run options
    singularity_run_options = '--bind /scratch:/scratch --bind /data:/data'
    
    // -------------------------------------------------------------------------
    // DATABASE LOCATIONS (pre-downloaded for efficiency)
    // -------------------------------------------------------------------------
    
    // Uncomment and set paths to pre-downloaded databases
    // custom_kraken_db        = '/shared/databases/kraken2/k2_standard'
    // custom_sourmash_db      = ['/shared/databases/sourmash/gtdb-rs214.genomic.k31.zip']
    // custom_bowtie_host_index = '/shared/databases/bowtie2/human_GRCh38'
    // custom_checkm2_db       = '/shared/databases/checkm2/uniref100.KO.1.dmnd'
    // custom_gtdbtk_db        = '/shared/databases/gtdbtk/release214'
    // custom_deeparg_db       = '/shared/databases/deeparg'
    
    // -------------------------------------------------------------------------
    // RESOURCE LIMITS (adjust to match your cluster)
    // -------------------------------------------------------------------------
    
    max_cpus   = 64
    max_memory = '256.GB'
    max_time   = '168.h'
}

process {
    executor = 'slurm'
    queue    = { params.slurm_queue }
    
    // Account specification (if required by your cluster)
    clusterOptions = {
        def opts = []
        if (params.slurm_account) opts << "--account=${params.slurm_account}"
        // Add other cluster-specific options here
        // opts << "--constraint=skylake"
        // opts << "--reservation=bioinfo"
        return opts.join(' ')
    }
    
    // Scratch directory for temporary files
    scratch = '/scratch/${USER}/nextflow'
    
    // Error handling
    errorStrategy = { task.exitStatus in [143,137,104,134,139,140] ? 'retry' : 'finish' }
    maxRetries    = 2
}

executor {
    name            = 'slurm'
    queueSize       = 100
    submitRateLimit = '10 sec'
    pollInterval    = '30 sec'
}

singularity {
    enabled    = true
    autoMounts = true
    cacheDir   = params.singularity_cache
    runOptions = params.singularity_run_options
}

// -------------------------------------------------------------------------
// ENVIRONMENT MODULES (if your cluster uses Lmod/modules)
// -------------------------------------------------------------------------
// Uncomment and customize if needed
// env {
//     PATH = "/opt/software/singularity/bin:\$PATH"
// }

// -------------------------------------------------------------------------
// CUSTOM PROCESS CONFIGURATIONS
// -------------------------------------------------------------------------
// Override specific process settings if needed
// process {
//     withName: 'MEGAHIT.*' {
//         queue = 'himem'
//         memory = '128.GB'
//     }
//     withName: 'GTDB_TK.*' {
//         queue = 'himem'
//         memory = '256.GB'
//     }
// }
