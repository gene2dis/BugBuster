/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Google Cloud Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Configuration for running BugBuster on Google Cloud Life Sciences / Batch

    Use as follows:
        nextflow run main.nf -profile gcp,docker --outdir gs://bucket/results

    Required:
        - Google Cloud SDK authenticated
        - GOOGLE_APPLICATION_CREDENTIALS environment variable (for service account)

----------------------------------------------------------------------------------------
*/

params {
    config_profile_name        = 'Google Cloud'
    config_profile_description = 'Google Cloud Batch/Life Sciences execution with GCS storage'
}

// Use Google Cloud Batch (recommended for new projects)
// For older projects, change to 'google-lifesciences'
process {
    executor = 'google-batch'
    
    // Error handling for preemptible instances
    errorStrategy = { task.exitStatus in [143,137,104,134,139,140,14] ? 'retry' : 'finish' }
    maxRetries    = 3
}

google {
    project = params.gcp_project ?: null
    region  = params.gcp_region ?: 'us-central1'
    
    // Google Batch settings
    batch {
        spot = params.gcp_spot ?: false  // Use spot/preemptible instances
        
        // Boot disk settings
        bootDiskSize = params.gcp_boot_disk_size ?: '50.GB'
        
        // Service account (optional)
        serviceAccountEmail = params.gcp_service_account ?: null
        
        // Network settings
        network    = params.gcp_network ?: null
        subnetwork = params.gcp_subnetwork ?: null
        usePrivateAddress = params.gcp_private_address ?: false
    }
    
    // Life Sciences settings (if using google-lifesciences executor)
    lifeSciences {
        bootDiskSize = params.gcp_boot_disk_size ?: '50.GB'
        preemptible  = params.gcp_spot ?: false
        
        // Debug mode keeps VMs alive on failure
        debug = params.gcp_debug ?: false
        
        // Service account
        serviceAccountEmail = params.gcp_service_account ?: null
    }
    
    // Storage settings
    storage {
        maxParallelTransfers = 4
        parallelThreadCount  = 4
        downloadMaxComponents = 8
    }
}

// Fusion filesystem for better GCS performance (optional, requires Nextflow 23.10+)
// fusion {
//     enabled = true
//     exportStorageCredentials = true
// }

// Wave container provisioning (optional)
// wave {
//     enabled = true
// }

// GCS work directory
workDir = params.gcp_workdir ?: 'gs://your-bucket/work'

// Container settings
docker {
    enabled = true
}

// Tower/Seqera Platform integration (optional)
// tower {
//     enabled    = true
//     accessToken = secrets.TOWER_ACCESS_TOKEN
//     workspaceId = params.tower_workspace_id
// }
